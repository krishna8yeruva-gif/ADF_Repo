name: Assign RBAC roles to ADF Managed Identity

on:
  workflow_dispatch:
    inputs:
      subscription_id:
        description: 'Azure Subscription ID'
        required: true
      resource_group:
        description: 'Resource Group name'
        required: true
      factory_name:
        description: 'Data Factory name'
        required: true
      msi_object_id:
        description: 'Managed Identity Object ID (from Factory → Properties → Managed identity)'
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  assign-roles:
    name: Assign Reader and Cost Management Reader to ADF Managed Identity
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ github.event.inputs.subscription_id }}

      - name: Assign Reader role on factory scope
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            FACTORY_SCOPE="/subscriptions/${{ github.event.inputs.subscription_id }}/resourceGroups/${{ github.event.inputs.resource_group }}/providers/Microsoft.DataFactory/factories/${{ github.event.inputs.factory_name }}"

            echo "Assigning Reader role..."
            echo "  Assignee : ${{ github.event.inputs.msi_object_id }}"
            echo "  Scope    : ${FACTORY_SCOPE}"

            # Check if assignment already exists
            EXISTING=$(az role assignment list \
              --assignee "${{ github.event.inputs.msi_object_id }}" \
              --role "Reader" \
              --scope "${FACTORY_SCOPE}" \
              --query "[].id" -o tsv 2>/dev/null)

            if [ -n "$EXISTING" ]; then
              echo "✅ Reader role already assigned on factory scope — nothing to do."
            else
              az role assignment create \
                --assignee-object-id "${{ github.event.inputs.msi_object_id }}" \
                --assignee-principal-type ServicePrincipal \
                --role "Reader" \
                --scope "${FACTORY_SCOPE}"
              echo "✅ Reader role assigned on factory scope."
            fi

      - name: Assign Cost Management Reader role on subscription scope
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            SUB_SCOPE="/subscriptions/${{ github.event.inputs.subscription_id }}"

            echo "Assigning Cost Management Reader role..."
            echo "  Assignee : ${{ github.event.inputs.msi_object_id }}"
            echo "  Scope    : ${SUB_SCOPE}"

            EXISTING=$(az role assignment list \
              --assignee "${{ github.event.inputs.msi_object_id }}" \
              --role "Cost Management Reader" \
              --scope "${SUB_SCOPE}" \
              --query "[].id" -o tsv 2>/dev/null)

            if [ -n "$EXISTING" ]; then
              echo "✅ Cost Management Reader already assigned on subscription scope — nothing to do."
            else
              az role assignment create \
                --assignee-object-id "${{ github.event.inputs.msi_object_id }}" \
                --assignee-principal-type ServicePrincipal \
                --role "Cost Management Reader" \
                --scope "${SUB_SCOPE}"
              echo "✅ Cost Management Reader role assigned on subscription scope."
            fi

      - name: Verify role assignments
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            FACTORY_SCOPE="/subscriptions/${{ github.event.inputs.subscription_id }}/resourceGroups/${{ github.event.inputs.resource_group }}/providers/Microsoft.DataFactory/factories/${{ github.event.inputs.factory_name }}"
            SUB_SCOPE="/subscriptions/${{ github.event.inputs.subscription_id }}"

            echo "=== Role assignments for MSI ${{ github.event.inputs.msi_object_id }} ==="
            az role assignment list \
              --assignee "${{ github.event.inputs.msi_object_id }}" \
              --query "[].{Role:roleDefinitionName, Scope:scope}" \
              --output table
